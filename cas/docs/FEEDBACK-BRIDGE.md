# CAS Feedback Automation Bridge

## Overview

The Feedback Automation Bridge connects Sage (AI Tutor) and Lexi (Help Bot) user feedback to CAS agents (Planner and Analyst) for automated analysis and task generation.

**Status**: ✅ Active
**Deployment Date**: 2026-02-21
**Cron Schedule**: Hourly (0 * * * *)
**Edge Function**: `cas-feedback-processor`

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      User Feedback Flow                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────┐
    │        ai_feedback table                    │
    │   (thumbs_up/down, ratings, comments)       │
    │   - agent_type: 'sage' | 'lexi'            │
    │   - processed: boolean                      │
    └─────────────────────────────────────────────┘
                              │
                              ▼
    ┌─────────────────────────────────────────────┐
    │   cas-feedback-processor Edge Function      │
    │   (Runs hourly via pg_cron)                │
    │                                             │
    │   1. Detect patterns in negative feedback   │
    │   2. Generate tasks for CAS Planner         │
    │   3. Generate reports for CAS Analyst       │
    │   4. Mark feedback as processed             │
    └─────────────────────────────────────────────┘
                    │                      │
                    ▼                      ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │  cas_planner_tasks    │   │ cas_analyst_reports   │
    │  (Actionable items)   │   │ (Analysis & insights) │
    └───────────────────────┘   └───────────────────────┘
                    │                      │
                    ▼                      ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │   CAS Planner Agent   │   │  CAS Analyst Agent    │
    │  (Task execution)     │   │  (Deep investigation) │
    └───────────────────────┘   └───────────────────────┘
```

---

## Database Schema

### cas_planner_tasks

Stores automated tasks generated by feedback analysis.

```sql
CREATE TABLE cas_planner_tasks (
    id UUID PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    task_type TEXT NOT NULL,  -- 'curriculum_fix', 'bug_fix', etc.
    priority TEXT NOT NULL,   -- 'critical', 'high', 'medium', 'low'

    -- Source tracking
    source TEXT NOT NULL,                -- 'feedback_processor'
    source_agent TEXT,                   -- 'sage', 'lexi', 'both'
    source_data JSONB NOT NULL,          -- Feedback IDs, user IDs

    -- Pattern analysis
    pattern_detected TEXT,               -- Pattern identifier
    occurrence_count INTEGER DEFAULT 1,  -- How many times detected
    affected_users_count INTEGER,        -- Number of users affected
    first_occurrence_at TIMESTAMPTZ,

    -- Status
    status TEXT DEFAULT 'pending',       -- 'pending', 'approved', etc.
    assigned_to TEXT,                    -- Which CAS agent
    estimated_impact TEXT,               -- 'high', 'medium', 'low'

    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL
);
```

**Task Types**:
- `curriculum_fix` - Fix curriculum content issue (Sage)
- `feature_request` - Implement user-requested feature
- `bug_fix` - Fix reported bug
- `performance_issue` - Address performance problem
- `content_gap` - Add missing curriculum content
- `ux_improvement` - Improve user experience
- `analytics_review` - Review metrics and insights

### cas_analyst_reports

Stores analytical reports generated by feedback patterns.

```sql
CREATE TABLE cas_analyst_reports (
    id UUID PRIMARY KEY,
    report_type TEXT NOT NULL,         -- 'feedback_pattern', etc.
    title TEXT NOT NULL,
    summary TEXT NOT NULL,

    -- Analysis scope
    agent_scope TEXT,                  -- 'sage', 'lexi', 'both'
    time_period_start TIMESTAMPTZ NOT NULL,
    time_period_end TIMESTAMPTZ NOT NULL,

    -- Analysis results
    metrics JSONB NOT NULL,            -- Key metrics
    findings JSONB NOT NULL,           -- Array of findings
    recommendations JSONB NOT NULL,    -- Array of recommendations

    -- Data sources
    data_sources JSONB NOT NULL,       -- Metadata
    sample_feedback_ids UUID[],        -- Sample feedback analyzed

    -- Severity
    severity TEXT,                     -- 'critical', 'high', etc.
    estimated_impact TEXT,
    affected_users_count INTEGER,

    -- Review status
    status TEXT DEFAULT 'pending',     -- 'pending', 'reviewed', etc.
    reviewed_at TIMESTAMPTZ,
    action_notes TEXT,

    -- Relations
    related_planner_tasks UUID[],      -- Links to generated tasks

    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL
);
```

**Report Types**:
- `feedback_pattern` - Analysis of feedback patterns
- `user_satisfaction` - Satisfaction trend analysis
- `topic_performance` - Subject/topic performance review
- `agent_comparison` - Sage vs Lexi performance
- `engagement_trend` - User engagement analysis
- `error_analysis` - Error pattern analysis
- `weekly_summary` - Weekly metrics summary

---

## Pattern Detection Logic

The feedback processor detects patterns by:

1. **Grouping Feedback**:
   - By agent (Sage/Lexi)
   - By topic/subject (from feedback context)
   - By time window (24 hours)

2. **Significance Threshold**:
   - 3+ negative feedback instances, OR
   - 2+ unique users affected

3. **Priority Assignment**:
   - **Critical**: 10+ instances OR 5+ users
   - **High**: 5+ instances OR 3+ users
   - **Medium**: 3+ instances OR 2+ users
   - **Low**: Otherwise

4. **Deduplication**:
   - Checks for existing tasks with same pattern
   - Prevents duplicate task creation

---

## Example Outputs

### Generated Task

```json
{
  "title": "Sage: High negative feedback on quadratic_equations",
  "description": "Detected 8 negative feedback instances from 4 users on topic \"quadratic_equations\". Investigation needed to identify root cause and implement fix.",
  "task_type": "curriculum_fix",
  "priority": "high",
  "source": "feedback_processor",
  "source_agent": "sage",
  "pattern_detected": "sage_quadratic_equations",
  "occurrence_count": 8,
  "affected_users_count": 4,
  "estimated_impact": "medium"
}
```

### Generated Report

```json
{
  "report_type": "feedback_pattern",
  "title": "Feedback Pattern Analysis: 3 patterns detected",
  "summary": "Analyzed 25 feedback entries and detected 3 significant negative patterns affecting 7 users. 2 Sage issues, 1 Lexi issue.",
  "agent_scope": "both",
  "metrics": {
    "totalFeedback": 25,
    "totalNegative": 15,
    "patternsDetected": 3,
    "sagePatterns": 2,
    "lexiPatterns": 1,
    "affectedUsers": 7
  },
  "findings": [
    {
      "type": "pattern",
      "agent": "sage",
      "topic": "quadratic_equations",
      "severity": "high",
      "description": "8 negative feedback instances on \"quadratic_equations\" from 4 users",
      "affectedCount": 4
    }
  ],
  "recommendations": [
    {
      "priority": "high",
      "action": "Review Sage curriculum content for topics: quadratic_equations, algebra",
      "expectedImpact": "Improve student satisfaction and learning outcomes"
    }
  ]
}
```

---

## Deployment

### Database Tables

Created via migrations:
- `273_create_cas_planner_tasks.sql`
- `274_create_cas_analyst_reports.sql`

Run deployment:
```bash
npx tsx tools/scripts/deploy-feedback-bridge.ts
```

### Edge Function

Deploy the feedback processor:
```bash
supabase functions deploy cas-feedback-processor --no-verify-jwt
```

Or manually via Supabase Dashboard:
1. Go to Edge Functions
2. Create new function: `cas-feedback-processor`
3. Upload `supabase/functions/cas-feedback-processor/index.ts`

### Cron Job

Runs hourly (0 * * * *):
```sql
SELECT cron.schedule(
  'cas-feedback-processor-hourly',
  '0 * * * *',
  $$
  SELECT net.http_post(
    url:='https://lvsmtgmpoysjygdwcrir.supabase.co/functions/v1/cas-feedback-processor',
    headers:='{"Content-Type": "application/json", "Authorization": "Bearer tutorwise-cron-2024-cas-feedback"}'::jsonb,
    body:='{}'::jsonb
  ) AS request_id;
  $$
);
```

**Cron Job ID**: 50

---

## Monitoring & Maintenance

### View Recent Tasks

```sql
SELECT
  title,
  task_type,
  priority,
  source_agent,
  occurrence_count,
  affected_users_count,
  status,
  created_at
FROM cas_planner_tasks
ORDER BY created_at DESC
LIMIT 20;
```

### View Recent Reports

```sql
SELECT
  title,
  report_type,
  agent_scope,
  severity,
  affected_users_count,
  status,
  created_at
FROM cas_analyst_reports
ORDER BY created_at DESC
LIMIT 10;
```

### Monitor Cron Execution

```sql
SELECT
  runid,
  job_pid,
  status,
  return_message,
  start_time,
  end_time
FROM cron.job_run_details
WHERE jobname = 'cas-feedback-processor-hourly'
ORDER BY start_time DESC
LIMIT 20;
```

### View Unprocessed Feedback

```sql
SELECT
  agent_type,
  rating,
  COUNT(*) as count
FROM ai_feedback
WHERE processed = false
GROUP BY agent_type, rating
ORDER BY count DESC;
```

### Manually Trigger Processor

```bash
curl -X POST \
  'https://lvsmtgmpoysjygdwcrir.supabase.co/functions/v1/cas-feedback-processor' \
  -H 'Authorization: Bearer tutorwise-cron-2024-cas-feedback' \
  -H 'Content-Type: application/json'
```

---

## Troubleshooting

### No Tasks Generated

**Possible Causes**:
- No unprocessed negative feedback in last 24 hours
- Feedback doesn't meet significance threshold (3+ instances or 2+ users)
- Pattern already has pending task (deduplication)

**Resolution**:
1. Check unprocessed feedback count
2. Review significance thresholds
3. Check for existing tasks with same pattern

### Cron Not Running

**Possible Causes**:
- pg_cron extension disabled
- Job schedule syntax error
- Edge Function not deployed

**Resolution**:
1. Verify `cron.job` table for job entry
2. Check `cron.job_run_details` for errors
3. Manually test Edge Function endpoint

### Edge Function Errors

**Possible Causes**:
- Missing environment variables
- Database permission issues
- Invalid SQL queries

**Resolution**:
1. Check Edge Function logs in Supabase Dashboard
2. Verify CRON_SECRET environment variable
3. Test manually with curl command

---

## Future Enhancements

1. **Real-time Processing**:
   - Database trigger on `ai_feedback` inserts
   - Immediate task creation for critical issues

2. **Sentiment Analysis**:
   - NLP analysis of feedback comments
   - Emotion detection for better categorization

3. **Trend Detection**:
   - Week-over-week comparison
   - Seasonal pattern recognition

4. **User Segmentation**:
   - Analyze patterns by user role (student/tutor/agent)
   - Track feedback by user cohorts

5. **Integration with CAS Planner**:
   - Automatic task approval for low-risk fixes
   - Direct execution of simple tasks

---

**Status**: ✅ Active
**Last Updated**: 2026-02-21
**Version**: 1.0
