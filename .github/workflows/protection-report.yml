name: 🛡️ Critical Files Protection Report

on:
  schedule:
    # Run at 6:02 AM UTC (7:02 AM BST / 6:02 AM GMT)
    - cron: '2 6 * * *'
    # Run at 6:02 PM UTC (7:02 PM BST / 6:02 PM GMT)
    - cron: '2 18 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '22.x'

jobs:
  run-protection-report:
    name: 🔒 Generate and Email Protection Report
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: 📦 Install dependencies
      run: npm ci

    - name: 📝 Create .env.local from secrets
      run: |
        cat > .env.local << EOF
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        RESEND_FROM_EMAIL="${{ secrets.RESEND_FROM_EMAIL }}"
        EOF

    - name: 🛡️ Generate protection report
      run: ./tools/scripts/run-protection-report.sh
      continue-on-error: true

    - name: 📧 Check email status
      run: |
        if grep -qi "email sent successfully\|Protection report email sent successfully" logs/protection-report-cron.log; then
          echo "✅ Protection report email sent successfully!"
          exit 0
        else
          echo "⚠️ Email may not have been sent. Check logs."
          tail -50 logs/protection-report-cron.log
          exit 1
        fi

    - name: 📊 Display protection stats
      if: always()
      run: |
        if [ -f logs/protection-report-cron.log ]; then
          echo "Protection Report Summary:"
          grep -E "tier1|tier2|tier3|violations|total" logs/protection-report-cron.log | tail -10
        fi

    - name: 📎 Upload protection logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: protection-report-${{ github.run_number }}
        path: |
          logs/protection-report-cron.log
        retention-days: 30

    - name: 💬 Notify on failure
      if: failure()
      run: |
        echo "::error::Protection report failed. Check the logs artifact for details."

    - name: 🚨 Alert on violations
      if: always()
      run: |
        if grep -q '"violations": [1-9]' logs/protection-report-cron.log; then
          echo "::warning::⚠️ Critical files violations detected! Check the email report."
        fi
