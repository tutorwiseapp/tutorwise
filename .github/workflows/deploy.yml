name: ðŸš€ Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'

jobs:
  # Pre-deployment Quality Gate
  pre-deployment-check:
    name: âœ… Pre-deployment Verification
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: âœ¨ Quality check
      run: npm run quality:check

    - name: ðŸ—ï¸ Build verification
      run: npm run build
      env:
        SKIP_ENV_VALIDATION: true

    - name: ðŸ§ª Critical E2E tests
      run: npm run test:e2e tests/e2e/auth.spec.ts tests/e2e/homepage.spec.ts
      continue-on-error: true

  # Frontend Deployment to Vercel
  deploy-frontend:
    name: ðŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    environment: production
    if: github.repository == 'tutorwiseapp/tutorwise'

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'

  # Backend Deployment (ON-HOLD - Future Roadmap)
  # FastAPI backend + Railway deployment planned for future implementation
  # Currently using Next.js API Routes + Supabase (cloud-hosted)
  
  # deploy-backend:
  #   name: ðŸ”Œ Deploy Backend (ON-HOLD)
  #   runs-on: ubuntu-latest
  #   needs: pre-deployment-check
  #   environment: production
  #   steps:
  #     - name: âš ï¸ Railway deployment on-hold
  #       run: echo "FastAPI backend deployment planned for future"

  # Post-deployment verification
  post-deployment-verification:
    name: ðŸ” Post-deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: needs.deploy-frontend.result == 'success'
    environment: production

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm ci

    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install chromium

    - name: âœ… Production smoke tests
      run: |
        npx playwright test tests/e2e/homepage.spec.ts \
          --config=playwright.config.ts \
          --project=chromium
      env:
        BASE_URL: https://tutorwise.vercel.app

    - name: ðŸ¥ Frontend health check
      run: curl -f https://tutorwise.vercel.app || exit 1

  # Deployment notifications (Slack removed - not in use)
  notify-deployment:
    name: ðŸ“¢ Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-frontend, post-deployment-verification]
    if: always()

    steps:
    - name: âœ… Deployment status
      run: |
        if [[ "${{ needs.post-deployment-verification.result }}" == "success" ]]; then
          echo "âœ… Deployment successful!"
          echo "Frontend: https://tutorwise.vercel.app"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi

    - name: ðŸ“Š Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: https://tutorwise.vercel.app" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: Supabase (cloud-hosted)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.post-deployment-verification.result }}" >> $GITHUB_STEP_SUMMARY
