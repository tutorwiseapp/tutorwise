name: Production Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.x'
  PYTHON_VERSION: '3.8'

jobs:
  # Pre-deployment Quality Gate
  pre-deployment-check:
    name: Pre-deployment Verification
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Quality check
      run: npm run quality:check

    - name: Build verification
      run: npm run build
      env:
        SKIP_ENV_VALIDATION: true

    - name: Critical E2E tests
      run: npm run test:e2e tests/e2e/auth.spec.ts tests/e2e/homepage.spec.ts
      continue-on-error: true

  # Frontend Deployment to Vercel
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'

    - name: Get Vercel URL
      id: vercel-url
      run: echo "url=$(vercel ls tutorwise --token ${{ secrets.VERCEL_TOKEN }} | grep https | head -1)" >> $GITHUB_OUTPUT

  # Backend Deployment to Railway (ON HOLD - uncomment when Railway is active)
  # deploy-backend:
  #   name: Deploy Backend
  #   runs-on: ubuntu-latest
  #   needs: pre-deployment-check
  #   environment: production
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #   - name: Deploy to Railway
  #     uses: berviantoleo/railway-deploy@main
  #     with:
  #       railway_token: ${{ secrets.RAILWAY_TOKEN }}
  #       service: tutorwise-backend
  #   - name: Wait for Railway deployment
  #     run: sleep 60
  #   - name: Health check
  #     run: curl -f https://tutorwise-production.up.railway.app/health || exit 1

  # Post-deployment verification
  post-deployment-verification:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install chromium

    - name: Production smoke tests
      run: |
        npx playwright test tests/e2e/homepage.spec.ts \
          --config=playwright.config.ts \
          --project=chromium
      env:
        BASE_URL: https://tutorwise.vercel.app

  # Deployment notifications
  notify-deployment:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-frontend, post-deployment-verification]
    if: always()

    steps:
    - name: Deployment complete
      run: |
        echo "Deployment workflow completed"
        echo "Status: ${{ needs.post-deployment-verification.result }}"


  # Rollback capability (manual trigger)
  rollback:
    name: Emergency Rollback
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [post-deployment-verification]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Rollback Vercel
      run: |
        # Get previous deployment
        PREV_DEPLOYMENT=$(vercel ls tutorwise --token ${{ secrets.VERCEL_TOKEN }} | grep https | sed -n '2p' | awk '{print $2}')
        # Promote previous deployment
        vercel promote $PREV_DEPLOYMENT --token ${{ secrets.VERCEL_TOKEN }}

    - name: Rollback notification
      run: |
        echo "Emergency rollback completed"
        echo "Previous deployment promoted to production"
