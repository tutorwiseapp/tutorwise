# DSPy Prompt Optimization Workflow
# Runs weekly to optimize Sage and Lexi prompts using user feedback

name: DSPy Prompt Optimization

on:
  # Weekly on Sunday at 3am UTC
  schedule:
    - cron: '0 3 * * 0'

  # Manual trigger
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to optimize (sage, lexi, or both)'
        required: true
        default: 'both'
        type: choice
        options:
          - sage
          - lexi
          - both
      signature:
        description: 'Signature to optimize (maths, explain, diagnose, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - maths
          - explain
          - diagnose
      dry_run:
        description: 'Dry run (do not mark feedback as processed)'
        required: false
        default: false
        type: boolean

jobs:
  optimize-sage:
    name: Optimize Sage Prompts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.agent == 'sage' || github.event.inputs.agent == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: cas/optimization/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r cas/optimization/requirements.txt

      - name: Run Sage optimization
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          cd cas/optimization
          python run_dspy.py \
            --agent sage \
            --signature ${{ github.event.inputs.signature || 'all' }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Upload optimization results
        uses: actions/upload-artifact@v4
        with:
          name: sage-optimization-results
          path: cas/optimization/output/optimized_sage_latest.json
          retention-days: 30

      - name: Commit optimized prompts
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "CAS Bot"
          git config user.email "cas-bot@tutorwise.com"
          git add cas/optimization/output/optimized_sage_latest.json
          git diff --cached --quiet || git commit -m "chore(dspy): Update Sage optimized prompts [skip ci]"
          git push || echo "Nothing to push"

  optimize-lexi:
    name: Optimize Lexi Prompts
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.agent == 'lexi' || github.event.inputs.agent == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: cas/optimization/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r cas/optimization/requirements.txt

      - name: Run Lexi optimization
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
        run: |
          cd cas/optimization
          python run_dspy.py \
            --agent lexi \
            --signature ${{ github.event.inputs.signature || 'all' }} \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}

      - name: Upload optimization results
        uses: actions/upload-artifact@v4
        with:
          name: lexi-optimization-results
          path: cas/optimization/output/optimized_lexi_latest.json
          retention-days: 30

      - name: Commit optimized prompts
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "CAS Bot"
          git config user.email "cas-bot@tutorwise.com"
          git add cas/optimization/output/optimized_lexi_latest.json
          git diff --cached --quiet || git commit -m "chore(dspy): Update Lexi optimized prompts [skip ci]"
          git push || echo "Nothing to push"

  notify:
    name: Notify on completion
    runs-on: ubuntu-latest
    needs: [optimize-sage, optimize-lexi]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Sage optimization: ${{ needs.optimize-sage.result }}"
          echo "Lexi optimization: ${{ needs.optimize-lexi.result }}"

          if [ "${{ needs.optimize-sage.result }}" == "failure" ] || [ "${{ needs.optimize-lexi.result }}" == "failure" ]; then
            echo "::warning::One or more optimization jobs failed"
          fi
