name: Security Pre-Deployment Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for secrets in code
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check dependency vulnerabilities
        run: |
          echo "=== Checking for known vulnerabilities ==="
          npm audit --json > /tmp/audit.json || true

          # Count high/critical vulnerabilities
          HIGH=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0')

          echo "High vulnerabilities: $HIGH"
          echo "Critical vulnerabilities: $CRITICAL"

          # Fail if critical vulnerabilities found
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Critical vulnerabilities found!"
            exit 1
          fi

      - name: Check for hardcoded secrets patterns
        run: |
          echo "=== Scanning for hardcoded secrets ==="

          # Define patterns to check
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "private_key"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" --include='*.ts' --include='*.tsx' --include='*.js' apps/ packages/ lexi/ sage/ 2>/dev/null | grep -v node_modules | grep -v '.test.' | grep -v 'example'; then
              echo "::warning::Potential secret pattern found: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "::warning::Review the above findings for potential hardcoded secrets"
          fi

      - name: Check access control files
        run: |
          echo "=== Checking role-based access control ==="

          # Verify access control exists in key paths
          FILES=(
            "sage/services/access-control.ts"
            "sage/context/resolver.ts"
          )

          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"

              # Check for role checks
              if grep -q "userRole\|checkAccess\|hasPermission" "$file"; then
                echo "  ✓ Contains role checks"
              else
                echo "  ⚠ May be missing role checks"
              fi
            else
              echo "⚠ $file not found"
            fi
          done

      - name: Scan Lexi/Sage for injection risks
        run: |
          echo "=== Checking for injection vulnerabilities ==="

          # Check for unsafe string interpolation in SQL-like contexts
          if grep -r -E "\.query\(\`.*\$\{" --include='*.ts' lexi/ sage/ 2>/dev/null; then
            echo "::warning::Potential SQL injection risk - review string interpolation in queries"
          fi

          # Check for unsafe eval usage
          if grep -r -E "\beval\s*\(" --include='*.ts' --include='*.tsx' apps/ lexi/ sage/ 2>/dev/null; then
            echo "::error::eval() usage detected - this is a security risk"
          fi

          # Check for innerHTML usage
          if grep -r "dangerouslySetInnerHTML" --include='*.tsx' apps/ 2>/dev/null | grep -v node_modules; then
            echo "::warning::dangerouslySetInnerHTML usage found - ensure content is sanitized"
          fi

      - name: Generate security report
        if: always()
        run: |
          mkdir -p /tmp/security-reports

          cat << EOF > /tmp/security-reports/scan-summary.md
          # Security Scan Summary

          **Date:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Checks Performed
          - [x] Gitleaks secret scanning
          - [x] npm audit for dependencies
          - [x] Hardcoded secret patterns
          - [x] Access control verification
          - [x] Injection vulnerability scan

          ## Next Steps
          - Review any warnings above
          - Run full security scan with: \`npm run security:full\`
          - Check EduPay payment code paths manually
          EOF

          cat /tmp/security-reports/scan-summary.md

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: /tmp/security-reports/
          retention-days: 30

  block-on-critical:
    name: Block Deployment on Critical Issues
    runs-on: ubuntu-latest
    needs: security-scan
    if: failure()

    steps:
      - name: Block deployment
        run: |
          echo "::error::Security scan failed - deployment blocked"
          echo "Please review and fix security issues before merging"
          exit 1
