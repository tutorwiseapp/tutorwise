/**
 * Filename: DelegationSettingsPanel.tsx
 * Purpose: Hierarchical commission delegation settings UI (Patent Section 7.2, 7.3)
 * Created: 2025-12-16
 * Updated: 2025-12-18 - Added hierarchical delegation (profile + listing levels)
 * Patent Reference: Section 7 (Commission Delegation Mechanism) - CORE NOVELTY
 * Migration: 129 (profile-level), 130 (hierarchical resolution)
 *
 * Features:
 * - Profile-level default delegation (applies to all listings)
 * - Listing-specific delegation overrides (highest precedence)
 * - Hierarchical resolution visualization
 * - Search/select partner agents by referral code
 * - Validate partner exists before saving
 * - Clear delegation to revert to normal commission flow
 * - Pagination for large listing counts
 *
 * Hierarchical Logic (Patent Section 7.3):
 * Level 1: Listing-specific delegation (highest precedence)
 * Level 2: Profile-level default delegation (fallback)
 * Level 3: Original referral attribution (base case)
 */

'use client';

import React, { useState, useEffect } from 'react';
import {
  Building2,
  UserCheck,
  AlertCircle,
  Search,
  X,
  Check,
  Info,
  DollarSign,
  TrendingDown,
  Users,
  ChevronLeft,
  ChevronRight,
} from 'lucide-react';
import { createClient } from '@/utils/supabase/client';
import HubDetailCard from '@/app/components/hub/content/HubDetailCard/HubDetailCard';
import type { DetailField } from '@/app/components/hub/content/HubDetailCard/HubDetailCard';
import HubPagination from '@/app/components/hub/layout/HubPagination';
import Button from '@/app/components/ui/actions/Button';
import styles from './DelegationSettingsPanel.module.css';

interface PartnerProfile {
  id: string;
  full_name: string;
  referral_code: string;
  profile_picture_url?: string | null;
}

interface Listing {
  id: string;
  title: string;
  type: 'listing' | 'product' | 'service';
  status: 'active' | 'inactive';
  delegate_commission_to_profile_id: string | null;
  delegated_partner?: PartnerProfile | null;
}

interface DelegationSettingsPanelProps {
  tutorId: string;
  className?: string;
}

const ITEMS_PER_PAGE = 4;

export default function DelegationSettingsPanel({
  tutorId,
  className = '',
}: DelegationSettingsPanelProps) {
  const supabase = createClient();

  // State
  const [listings, setListings] = useState<Listing[]>([]);
  const [profileDefaultPartner, setProfileDefaultPartner] = useState<PartnerProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [searchCode, setSearchCode] = useState('');
  const [searchResult, setSearchResult] = useState<PartnerProfile | null>(null);
  const [searchError, setSearchError] = useState<string | null>(null);
  const [editingTarget, setEditingTarget] = useState<'profile' | string | null>(null); // 'profile' or listing ID
  const [saving, setSaving] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);

  // Fetch profile default delegation + tutor's listings
  useEffect(() => {
    async function fetchData() {
      setLoading(true);

      // Fetch profile with default delegation partner
      const { data: profileData } = await supabase
        .from('profiles')
        .select(
          `
          id,
          default_commission_delegate_id,
          default_partner:default_commission_delegate_id (
            id,
            full_name,
            referral_code,
            profile_picture_url
          )
        `
        )
        .eq('id', tutorId)
        .single();

      if (profileData?.default_partner) {
        setProfileDefaultPartner(profileData.default_partner as PartnerProfile);
      }

      // Fetch listings with delegation partners
      const { data: listingsData } = await supabase
        .from('listings')
        .select(
          `
          id,
          title,
          type,
          status,
          delegate_commission_to_profile_id,
          delegated_partner:delegate_commission_to_profile_id (
            id,
            full_name,
            referral_code,
            profile_picture_url
          )
        `
        )
        .eq('profile_id', tutorId)
        .in('status', ['active', 'inactive'])
        .order('created_at', { ascending: false });

      if (listingsData) {
        setListings(
          listingsData.map((listing: any) => ({
            id: listing.id,
            title: listing.title,
            type: listing.type,
            status: listing.status,
            delegate_commission_to_profile_id: listing.delegate_commission_to_profile_id,
            delegated_partner: listing.delegated_partner as PartnerProfile | null,
          }))
        );
      }

      setLoading(false);
    }

    fetchData();
  }, [tutorId, supabase]);

  // Calculate how many listings use profile default vs have overrides
  const listingsUsingDefault = listings.filter(l => !l.delegate_commission_to_profile_id).length;
  const listingsWithOverrides = listings.filter(l => l.delegate_commission_to_profile_id).length;

  // Pagination
  const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
  const endIndex = startIndex + ITEMS_PER_PAGE;
  const paginatedListings = listings.slice(startIndex, endIndex);
  const totalPages = Math.ceil(listings.length / ITEMS_PER_PAGE);

  // Search for partner by referral code
  const handleSearchCode = async () => {
    if (!searchCode.trim()) {
      setSearchError('Please enter a referral code');
      return;
    }

    setSearchError(null);
    setSearchResult(null);

    const { data, error } = await supabase
      .from('profiles')
      .select('id, full_name, referral_code, profile_picture_url')
      .eq('referral_code', searchCode.toUpperCase())
      .single();

    if (error || !data) {
      setSearchError('Referral code not found. Please check and try again.');
      return;
    }

    if (data.id === tutorId) {
      setSearchError('You cannot delegate commissions to yourself.');
      return;
    }

    setSearchResult(data as PartnerProfile);
  };

  // Set profile-level default delegation
  const handleSetProfileDefault = async () => {
    if (!searchResult) return;

    setSaving(true);

    const { error } = await supabase
      .from('profiles')
      .update({ default_commission_delegate_id: searchResult.id })
      .eq('id', tutorId);

    if (!error) {
      setProfileDefaultPartner(searchResult);
      setEditingTarget(null);
      setSearchCode('');
      setSearchResult(null);
    }

    setSaving(false);
  };

  // Clear profile-level default delegation
  const handleClearProfileDefault = async () => {
    setSaving(true);

    const { error } = await supabase
      .from('profiles')
      .update({ default_commission_delegate_id: null })
      .eq('id', tutorId);

    if (!error) {
      setProfileDefaultPartner(null);
    }

    setSaving(false);
  };

  // Set delegation for a specific listing
  const handleSetListingDelegation = async (listingId: string) => {
    if (!searchResult) return;

    setSaving(true);

    const { error } = await supabase
      .from('listings')
      .update({ delegate_commission_to_profile_id: searchResult.id })
      .eq('id', listingId);

    if (!error) {
      setListings((prev) =>
        prev.map((listing) =>
          listing.id === listingId
            ? {
                ...listing,
                delegate_commission_to_profile_id: searchResult.id,
                delegated_partner: searchResult,
              }
            : listing
        )
      );
      setEditingTarget(null);
      setSearchCode('');
      setSearchResult(null);
    }

    setSaving(false);
  };

  // Clear delegation for a specific listing
  const handleClearListingDelegation = async (listingId: string) => {
    setSaving(true);

    const { error } = await supabase
      .from('listings')
      .update({ delegate_commission_to_profile_id: null })
      .eq('id', listingId);

    if (!error) {
      setListings((prev) =>
        prev.map((listing) =>
          listing.id === listingId
            ? { ...listing, delegate_commission_to_profile_id: null, delegated_partner: null }
            : listing
        )
      );
    }

    setSaving(false);
  };

  if (loading) {
    return (
      <div className={`${styles.panel} ${className}`}>
        <div className={styles.loading}>Loading delegation settings...</div>
      </div>
    );
  }

  return (
    <div className={`${styles.panel} ${className}`}>
      {/* Header */}
      <div className={styles.header}>
        <h2 className={styles.title}>
          <Building2 size={24} />
          Commission Delegation Settings
        </h2>
        <div className={styles.subtitle}>
          Redirect referral commissions from specific listings to your partners
        </div>
      </div>

      {/* Info Banner */}
      <div className={styles.infoBanner}>
        <Info size={20} />
        <div className={styles.infoContent}>
          <strong>How Commission Delegation Works (Patent Section 7):</strong>
          <ul>
            <li>
              <strong>Normal Flow:</strong> When someone books your listing via a referral, the referring agent
              earns £10 commission.
            </li>
            <li>
              <strong>Delegated Flow:</strong> When delegation is enabled for a listing, your chosen partner earns
              the £10 commission instead of the original referring agent.
            </li>
            <li>
              <strong>Use Case:</strong> Partner with marketing agencies, affiliate networks, or business partners
              who promote your services.
            </li>
          </ul>
        </div>
      </div>

      {/* Listings */}
      {listings.length === 0 ? (
        <div className={styles.emptyState}>
          <Building2 size={48} />
          <p>You don&apos;t have any listings yet.</p>
          <p className={styles.emptySubtext}>Create a listing to enable commission delegation.</p>
        </div>
      ) : (
        <div className={styles.listingsList}>
          {listings.map((listing) => (
            <div key={listing.id} className={styles.listingCard}>
              {/* Listing Header */}
              <div className={styles.listingHeader}>
                <div className={styles.listingInfo}>
                  <div className={styles.listingTitle}>{listing.title}</div>
                  <div className={styles.listingMeta}>
                    {listing.type} • {listing.status}
                  </div>
                </div>
                <div className={styles.listingStatus}>
                  {listing.delegate_commission_to_profile_id ? (
                    <div className={styles.delegatedBadge}>
                      <UserCheck size={16} />
                      Delegated
                    </div>
                  ) : (
                    <div className={styles.normalBadge}>Normal Flow</div>
                  )}
                </div>
              </div>

              {/* Current Delegation */}
              {listing.delegated_partner && (
                <div className={styles.currentDelegation}>
                  <div className={styles.partnerInfo}>
                    <UserCheck size={18} />
                    <div>
                      <div className={styles.partnerName}>{listing.delegated_partner.full_name}</div>
                      <div className={styles.partnerCode}>
                        Code: {listing.delegated_partner.referral_code}
                      </div>
                    </div>
                  </div>
                  <button
                    onClick={() => handleClearDelegation(listing.id)}
                    className={styles.clearButton}
                    disabled={saving}
                  >
                    <X size={16} />
                    Clear
                  </button>
                </div>
              )}

              {/* Edit Mode */}
              {editingListingId === listing.id ? (
                <div className={styles.editSection}>
                  {/* Search Box */}
                  <div className={styles.searchBox}>
                    <div className={styles.searchInput}>
                      <Search size={18} />
                      <input
                        type="text"
                        placeholder="Enter partner's referral code (e.g., ABC123)"
                        value={searchCode}
                        onChange={(e) => setSearchCode(e.target.value.toUpperCase())}
                        onKeyDown={(e) => e.key === 'Enter' && handleSearchCode()}
                      />
                    </div>
                    <button onClick={handleSearchCode} className={styles.searchButton}>
                      Search
                    </button>
                  </div>

                  {/* Search Error */}
                  {searchError && (
                    <div className={styles.errorMessage}>
                      <AlertCircle size={16} />
                      {searchError}
                    </div>
                  )}

                  {/* Search Result */}
                  {searchResult && (
                    <div className={styles.searchResult}>
                      <div className={styles.resultInfo}>
                        <Check size={18} className={styles.checkIcon} />
                        <div>
                          <div className={styles.resultName}>{searchResult.name}</div>
                          <div className={styles.resultCode}>Code: {searchResult.code}</div>
                        </div>
                      </div>
                      <div className={styles.resultActions}>
                        <button
                          onClick={() => handleSetDelegation(listing.id)}
                          className={styles.confirmButton}
                          disabled={saving}
                        >
                          {saving ? 'Saving...' : 'Confirm Delegation'}
                        </button>
                        <button
                          onClick={() => {
                            setEditingListingId(null);
                            setSearchCode('');
                            setSearchResult(null);
                            setSearchError(null);
                          }}
                          className={styles.cancelButton}
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Commission Impact Preview */}
                  {searchResult && (
                    <div className={styles.impactPreview}>
                      <DollarSign size={18} />
                      <div className={styles.impactContent}>
                        <strong>Commission Impact:</strong>
                        <div className={styles.impactComparison}>
                          <div className={styles.impactBefore}>
                            <TrendingDown size={16} />
                            Original Agent: <span className={styles.strikethrough}>£10</span> → £0
                          </div>
                          <div className={styles.impactAfter}>
                            <UserCheck size={16} />
                            {searchResult.name}: £0 → <span className={styles.highlight}>£10</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                // Edit Button
                !listing.delegated_partner && (
                  <button
                    onClick={() => setEditingListingId(listing.id)}
                    className={styles.editButton}
                  >
                    <UserCheck size={16} />
                    Enable Delegation
                  </button>
                )
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
